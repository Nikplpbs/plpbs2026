<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Dashboard 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
        <h1 class="text-3xl font-extrabold mb-8 text-gray-800 text-center border-b pb-4">แดชบอร์ดข้อมูลร้านค้า</h1>

        <div class="mb-8">
            <label class="block text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wide">กรุณาเลือก รหัสร้าน:</label>
            <div class="relative">
                <select id="storeSelect" class="block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none transition-all cursor-pointer">
                    <option value="">-- กำลังโหลดข้อมูล... --</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </div>

        <div class="overflow-hidden rounded-xl border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">เบอร์ผู้สั่ง</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">ชื่อผู้สั่ง</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-white uppercase">ราคาสุทธิ</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-white uppercase">เวลารับสินค้า</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="bg-white divide-y divide-gray-100">
                    <tr>
                        <td colspan="4" class="px-4 py-16 text-center text-gray-400 italic">กรุณาเลือกรหัสร้านค้าด้านบนเพื่อดูข้อมูล</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // *** วาง URL เว็บแอปที่ลงท้ายด้วย /exec ของคุณที่นี่ ***
        const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjllxVS9x5B5J_dO2rssBs7XbMRfyO4V3NYwpSI6jELodcrGt2lHGPtrQzYiPsVdR_hhgpBXJAEBeEgB3AvJoFMxGkjFGIK2gf_bUFRqJKTONvzRw9CQVDscM5AHfHsQSW7YkP5y9jG2pPzdZQU2_V9ehgN7oXcoLhFRw882wlHaY43ZuGb6hx0LFIcmIumihpWmjTok2vLnhQz7CmUwIIgeuUsFbBX3PKGraMn3cACfEIR2wBL40yWpQw3VtFOQ-yVIsf-StPyjx9UkuY-ULJavF1YvQ&lib=MbYqQw0DfnVniw0KCX3cUtARb25tth-fC"; 
        let allData = [];

        async function fetchData() {
            const select = document.getElementById('storeSelect');
            try {
                // ใช้ redirect: 'follow' เพื่อจัดการกับระบบ Redirect ของ Google Apps Script
                const response = await fetch(API_URL, {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!response.ok) throw new Error('Network error');

                const text = await response.text();
                allData = JSON.parse(text);
                
                console.log("Data loaded:", allData);
                populateDropdown(allData);
            } catch (error) {
                console.error("Error:", error);
                select.innerHTML = '<option>โหลดข้อมูลไม่สำเร็จ (ลอง Refresh)</option>';
                alert("ไม่สามารถดึงข้อมูลได้: โปรดตรวจสอบการ Deploy ใน Apps Script");
            }
        }

        function populateDropdown(data) {
            const select = document.getElementById('storeSelect');
            // ค้นหาคอลัมน์ "รหัสร้าน" (ตัดช่องว่างอัตโนมัติ)
            const stores = [...new Set(data.map(item => {
                const key = Object.keys(item).find(k => k.trim() === 'รหัสร้าน');
                return item[key];
            }))].filter(s => s);
            
            select.innerHTML = '<option value="">-- เลือก รหัสร้าน --</option>';
            stores.sort().forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = `รหัสร้าน: ${store}`;
                select.appendChild(option);
            });
        }

        document.getElementById('storeSelect').addEventListener('change', function(e) {
            const selectedStore = e.target.value;
            const tableBody = document.getElementById('tableBody');
            
            if (!selectedStore) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-16 text-center text-gray-400 italic">กรุณาเลือกรหัสร้านค้าด้านบนเพื่อดูข้อมูล</td></tr>';
                return;
            }

            const filtered = allData.filter(item => {
                const key = Object.keys(item).find(k => k.trim() === 'รหัสร้าน');
                return item[key] == selectedStore;
            });

            tableBody.innerHTML = "";
            filtered.forEach(item => {
                const val = (name) => {
                    const key = Object.keys(item).find(k => k.trim() === name);
                    return item[key] || '-';
                };

                const row = `
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-4 text-sm text-gray-600 border-b">${val('เบอร์ผู้สั่ง')}</td>
                        <td class="px-4 py-4 text-sm text-gray-900 font-medium border-b">${val('ชื่อผู้สั่ง')}</td>
                        <td class="px-4 py-4 text-sm text-right font-mono border-b text-emerald-600">${Number(val('ราคาสุทธิ')).toLocaleString()}</td>
                        <td class="px-4 py-4 text-sm text-center border-b font-semibold text-blue-600">${val('เวลารับสินค้า')}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        });

        fetchData();
    </script>
</body>
</html>
